name: Test Catalog

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate catalog artifacts
        run: npm run test:catalog

      - name: Quality gates
        run: npm run test:catalog:check

      - name: Compute catalog summary
        id: catalog_summary
        run: |
          node - <<'NODE'
          import fs from 'fs';
          import { execSync } from 'child_process';

          const output = process.env.GITHUB_OUTPUT;
          const current = JSON.parse(fs.readFileSync('docs/test-scenarios.json', 'utf8'));
          let previous = { scenarios: [] };
          try {
            const raw = execSync('git show HEAD:docs/test-scenarios.json', { stdio: ['ignore', 'pipe', 'ignore'] }).toString();
            previous = JSON.parse(raw);
          } catch (error) {
            previous = { scenarios: [] };
          }

          const prevMap = new Map(previous.scenarios?.map((s: any) => [s.scenario, s]) ?? []);
          const changed = [];
          for (const scenario of current.scenarios ?? []) {
            const prev = prevMap.get(scenario.scenario);
            if (!prev || JSON.stringify(prev) !== JSON.stringify(scenario)) {
              changed.push(scenario.scenario);
            }
          }

          const flaky = (current.scenarios ?? []).filter((s: any) => s.flaky || s.quarantine).map((s: any) => s.scenario);

          fs.appendFileSync(
            output,
            `total=${current.scenarios?.length ?? 0}\nchanged=${changed.join('|')}\nchanged_count=${changed.length}\nflaky=${flaky.join('|')}\nflaky_count=${flaky.length}\n`
          );
          NODE

      - name: Commit catalog updates
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          if git status --porcelain docs/test-scenarios.json docs/TEST_SCENARIO_CATALOG.md docs/test-matrix.md | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs/test-scenarios.json docs/TEST_SCENARIO_CATALOG.md docs/test-matrix.md
            git commit -m "chore: update test catalog [skip ci]"
            git push
          fi

      - name: Post PR summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          TOTAL: ${{ steps.catalog_summary.outputs.total }}
          CHANGED: ${{ steps.catalog_summary.outputs.changed }}
          CHANGED_COUNT: ${{ steps.catalog_summary.outputs.changed_count }}
          FLAKY: ${{ steps.catalog_summary.outputs.flaky }}
          FLAKY_COUNT: ${{ steps.catalog_summary.outputs.flaky_count }}
        with:
          script: |
            const total = process.env.TOTAL || '0';
            const changedCount = process.env.CHANGED_COUNT || '0';
            const flakyCount = process.env.FLAKY_COUNT || '0';
            const changedList = (process.env.CHANGED || '').split('|').filter(Boolean);
            const flakyList = (process.env.FLAKY || '').split('|').filter(Boolean);

            const bodyLines = [];
            bodyLines.push('<!-- test-catalog-report -->');
            bodyLines.push('## ðŸ§ª Test catalog summary');
            bodyLines.push(`- Total scenarios: ${total}`);
            bodyLines.push(`- Changed scenarios in this PR: ${changedCount}`);
            if (changedList.length > 0) {
              bodyLines.push(`  - ${changedList.join(', ')}`);
            }
            bodyLines.push(`- Flaky/quarantined scenarios: ${flakyCount}`);
            if (flakyList.length > 0) {
              bodyLines.push(`  - ${flakyList.join(', ')}`);
            }
            bodyLines.push('');
            bodyLines.push('See [TEST_SCENARIO_CATALOG.md](./docs/TEST_SCENARIO_CATALOG.md) for details.');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '<!-- test-catalog-report -->';
            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));
            const body = bodyLines.join('\n');

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
